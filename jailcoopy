#!/bin/bash

BIN_NAME=""
JAIL_ROOT=""
LIST=""

usage() {
	echo "USAGE: $0 -n <BINARY_NAME> -j <JAIL_ROOT>"
	echo -e "Options:"
	echo -e "\t-n <BINARY_NAME>\tBinary application name.\t Example: bash, sh, rsync"
	echo -e "\t-j <JAIL_ROOT>\t\tJailroot path.\t\t\t Example: /home/virtualhosts/example.dev	"
}

printError() {
	echo "[!] Invalid option" && usage && exit 1
}

function copyToJail {
	dirPath=`dirname $1`
	echo "copy $1 to $JAIL_ROOT$dirPath"		
	mkdir -p $JAIL_ROOT$dirPath
	cp $1 $JAIL_ROOT$dirPath
}

function findSoLibrary () {
	while IFS= read -r line
	do
		libName=`echo "$line" | awk '{print $1}'`
		libPath=`echo "$line" | awk '{print $3}'`

		if [ -s $libPath ] && [ -f $libPath ] && [ -e $libPath ] && [ ! -z "$libPath" -a "$libPath" != " " ]
		then
			copyToJail $libPath
		else
			if [ -s $libName ] && [ -f $libName ] && [ -e $libName ]
			then
				copyToJail $libName
			fi
		fi
	done <<< "$filesToCopy"

}

function copyBinFile () {
	fileName=$1
	binPath=`whereis $fileName | awk '{print $2}'`
	filesToCopy=`ldd $binPath`

	findSoLibrary filesToCopy
	copyToJail $binPath
}

function main () {
	if [ $LIST != "" ]
	then
		IFS=',' read -a binNameArray <<< "$LIST"
		echo $binNameArray
		for element in "${binNameArray[@]}"
		do
			echo $element
			copyBinFile "$element"
		done
	else
		copyBinFile "$BIN_NAME"
	fi
}

while getopts "n:j:l:" Option; do
	case $Option in
			n ) BIN_NAME="$OPTARG";;
			j ) JAIL_ROOT="$OPTARG";;
			l ) LIST="$OPTARG";;
			* ) printError;;
	esac
done

if [ "$JAIL_ROOT" != "" ] && { [ $LIST != "" ] || [ "$BIN_NAME" != ]; } then
	main
else
	printError
fi

exit 0